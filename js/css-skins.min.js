function fcn_validateCss(t){if("string"!=typeof t)return!1;if(t=t.replace(/^\uFEFF/,""),/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/.test(t))return!1;if(t.includes("<"))return!1;const n=t.replace(/\/\*[\s\S]*?\*\//g,""),s=n.replace(/(["'])(?:\\.|(?!\1)[\s\S])*?\1/g,'""');if((s.match(/{/g)||[]).length!==(s.match(/}/g)||[]).length)return!1;function e(t){try{const n=new URL(t);return"https:"===n.protocol&&"fonts.googleapis.com"===n.hostname&&n.pathname.startsWith("/css")}catch{return!1}}if(!function(t){const n=/@import\s+(?:url\s*\(\s*)?(?:"([^"]+)"|'([^']+)'|([^"')\s]+))\s*\)?\s*;/gi;let s;for(;null!==(s=n.exec(t));){if(!e((s[1]||s[2]||s[3]||"").trim()))return!1}return!0}(n))return!1;const i=s.toLowerCase();if(i.includes("</style")||i.includes("<style")||/expression\s*\(/.test(i)||/-moz-binding\b/.test(i)||/\bbehavior\s*:/.test(i)||/\bvbscript\s*:/.test(i))return!1;const a=/url\s*\(\s*([^)]+?)\s*\)/gi;let c;for(;null!==(c=a.exec(n));){let t=c[1].trim();(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1));const n=t.trim().toLowerCase().replace(/\s+/g,"");if(n.startsWith("javascript:")||n.startsWith("vbscript:"))return!1;if(n.startsWith("data:")){if(!/^(data:(image\/(png|jpeg|jpg|gif|webp|svg\+xml)|font\/(woff|woff2)|application\/font-woff2);)/i.test(n))return!1}}return!0}function fcn_getSkins(){const t=FcnUtils.getCookie("fcnLoggedIn");if(!t)return null;const n={data:{},active:null,fingerprint:t},s=FcnUtils.parseJSON(localStorage.getItem("fcnSkins"))??n;return("object"!=typeof s.data||Array.isArray(s.data))&&(s.data={}),s}function fcn_setSkins(t){"object"!=typeof t||null===t||"object"!=typeof t.data||Array.isArray(t.data)?fcn_showNotification(fcn_skinTranslations.invalidJson,3,"warning"):localStorage.setItem("fcnSkins",JSON.stringify(t))}function fcn_getSkinInfo(t){const n=t.match(/Name:\s*(.+)/),s=t.match(/Author:\s*(.+)/),e=t.match(/Version:\s*(.+)/);return{name:n?FcnUtils.sanitizeHTML(n[1].trim()):null,author:s?FcnUtils.sanitizeHTML(s[1].trim()):null,version:e?FcnUtils.sanitizeHTML(e[1].trim()):null}}function fcn_toggleSkin(t){const n=t.closest('[data-css-skin-finder="skin-item"]'),s=fcn_getSkins();n.classList.contains("active")?(_$$('[data-css-skin-finder="skin-item"]').forEach((t=>t.classList.remove("active"))),s.active=null):(_$$('[data-css-skin-finder="skin-item"]').forEach((t=>t.classList.remove("active"))),n.classList.add("active"),s.active=t.dataset.skinId),fcn_setSkins(s),fcn_applySkin()}function fcn_deleteSkin(t){const n=t.closest('[data-css-skin-finder="skin-item"]'),s=fcn_getSkins();n.classList.contains("active")&&(s.active=null),delete s.data[t.dataset.skinId],_$('[data-css-skin-target="file"]').value="",fcn_setSkins(s),fcn_renderSkinList(),fcn_applySkin()}function fcn_applySkin(){if(!FcnUtils.getCookie("fcnLoggedIn")||_$("body.wp-admin"))return;const t=fcn_getSkins();if(_$$$("fictioneer-active-custom-skin")?.remove(),t?.data?.[t.active]?.css){const n=document.createElement("style");n.textContent=t.data[t.active].css,n.id="fictioneer-active-custom-skin",_$("head").appendChild(n)}}function fcn_renderSkinList(){const t=_$('[data-css-skin-target="list"]');if(!FcnUtils.getCookie("fcnLoggedIn")||!t)return;const n=fcn_getSkins();t.innerHTML="",n?.data&&Object.keys(n.data).length>0&&(Object.entries(n.data).forEach((([s,e])=>{const i=_$('[data-css-skin-target="template"]').content.cloneNode(!0);n.active===s&&i.querySelector('[data-css-skin-finder="skin-item"]').classList.add("active"),i.querySelector('[data-action="click->css-skin#toggle"]').dataset.skinId=s,i.querySelector('[data-action="click->css-skin#delete"]').dataset.skinId=s,i.querySelector('[data-css-skin-finder="name"]').innerText=e.name,i.querySelector('[data-css-skin-finder="version"]').innerText=e.version,i.querySelector('[data-css-skin-finder="author"]').innerText=e.author,t.appendChild(i)})),_$$('[data-action="click->css-skin#toggle"]').forEach((t=>{t.addEventListener("click",(t=>fcn_toggleSkin(t.currentTarget)))})),_$$('[data-action="click->css-skin#delete"]').forEach((t=>{t.addEventListener("click",(t=>fcn_deleteSkin(t.currentTarget)))}))),Object.keys(n.data).length>2?_$('[data-css-skin-target="form"]').style.display="none":_$('[data-css-skin-target="form"]').style.display=""}function fcn_uploadSkins(t){if(!FcnUtils.loggedIn()||t.classList.contains("disabled"))return;const n=fcn_getSkins();n.fingerprint=FcnUtils.getCookie("fcnLoggedIn"),_$('[data-css-skin-target="action-status-message"]').classList.add("invisible"),FcnUtils.remoteAction("fictioneer_ajax_save_skins",{element:t,payload:{skins:JSON.stringify(n)},callback:t=>{t.success&&(fcn_showNotification(t.data.message,3,"success"),fcn_toggleSkinNotice(_$('[data-css-skin-target="action-status-message"]')))},finalCallback:()=>{_$('[data-css-skin-target="file"]').value=""}})}function fcn_downloadSkins(t){FcnUtils.loggedIn()&&!t.classList.contains("disabled")&&(_$('[data-css-skin-target="action-status-message"]').classList.add("invisible"),FcnUtils.remoteAction("fictioneer_ajax_get_skins",{element:t,callback:t=>{t.success&&(fcn_showNotification(t.data.message,3,"success"),fcn_toggleSkinNotice(_$('[data-css-skin-target="action-status-message"]')),fcn_setSkins(FcnUtils.parseJSON(t.data.skins)),fcn_renderSkinList(),fcn_applySkin())},finalCallback:()=>{_$('[data-css-skin-target="file"]').value="",_$$(".custom-skin button[disabled]").forEach((t=>t.disabled=!1))}}))}function fcn_toggleSkinNotice(t){t.classList.remove("invisible"),setTimeout((()=>{t.classList.add("invisible")}),3e3)}fcn_renderSkinList(),_$('[data-css-skin-target="file"]')?.addEventListener("input",(t=>{t.preventDefault();const n=t.currentTarget.files[0],s=fcn_getSkins();if(Object.keys(s.data).length>2)return void fcn_showNotification(fcn_skinTranslations.tooManySkins,3,"warning");if(!n)return;if(n.size>2e5)return void fcn_showNotification(fcn_skinTranslations.fileTooLarge,3,"warning");if("text/css"!==n.type)return void fcn_showNotification(fcn_skinTranslations.wrongFileType,3,"warning");const e=new FileReader;e.onload=t=>{const n=t.target.result,s=fcn_getSkinInfo(n),e=fcn_getSkins();if(!fcn_validateCss(n))return void fcn_showNotification(fcn_skinTranslations.invalidCss,5,"warning");if(!s.name)return void fcn_showNotification(fcn_skinTranslations.missingMetaData,3,"warning");const i=btoa(s.name);e.data[i]={name:s.name,version:s.version,author:s.author,css:n},fcn_setSkins(e),fcn_renderSkinList(),_$$(".custom-skin button[disabled]").forEach((t=>t.disabled=!1))},e.onerror=()=>{console.error(e.error),fcn_showNotification(e.error,3,"warning")},e.readAsText(n)})),_$('[data-action="click->css-skin#upload"]')?.addEventListener("click",(t=>{fcn_uploadSkins(t.currentTarget)})),_$('[data-action="click->css-skin#download"]')?.addEventListener("click",(t=>{fcn_downloadSkins(t.currentTarget)}));